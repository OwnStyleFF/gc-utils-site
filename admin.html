<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Administrador - Visitas</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body { background: #181a1b; color: #eee; }
        .admin-container { max-width: 700px; margin: 2rem auto; background: #23272b; border-radius: 10px; box-shadow: 0 2px 8px #0004; padding: 2rem; }
        h1 { text-align: center; margin-bottom: 2rem; }
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { padding: 0.5rem 1rem; border-bottom: 1px solid #444; }
        th { background: #222; }
        tr:last-child td { border-bottom: none; }
        .error { color: #ff6f61; margin-top: 1rem; text-align: center; }
        .admin-auth { text-align: center; margin-bottom: 2rem; }
        input[type=password] { padding: 0.5rem; border-radius: 5px; border: 1px solid #444; background: #222; color: #eee; }
        button { padding: 0.5rem 1.5rem; border-radius: 5px; border: none; background: #ffe066; color: #222; font-weight: bold; cursor: pointer; }
        button:disabled { background: #888; color: #ccc; }
    </style>
</head>
<body>
    <div class="admin-container">
        <h1>Panel de Visitas (Admin)</h1>
        <div class="admin-auth">
            <label for="admin-totp">Código TOTP (Google Authenticator):</label>
            <input type="text" id="admin-totp" placeholder="123456" maxlength="6" pattern="[0-9]{6}">
            <button id="admin-paste" type="button">Pegar</button>
            <button id="admin-login">Entrar</button>
        </div>
        <div id="admin-content" style="display:none;">
            <h2>IPs y Números de Visitante</h2>
            <div style="margin-bottom:1rem;display:flex;gap:1rem;align-items:center;flex-wrap:wrap;">
                <button id="admin-refresh">Actualizar</button>
                <label for="admin-interval">Intervalo de actualización:</label>
                <select id="admin-interval">
                    <option value="0">No actualizar automáticamente</option>
                    <option value="1000">1 segundo</option>
                    <option value="15000">15 segundos</option>
                    <option value="30000">30 segundos</option>
                    <option value="60000">1 minuto</option>
                    <option value="300000">5 minutos</option>
                    <option value="900000">15 minutos</option>
                    <option value="1800000">30 minutos</option>
                    <option value="3600000">1 hora</option>
                </select>
                <button id="admin-export" style="background:#ffe066;color:#222;">Exportar CSV</button>
                <button id="admin-logout" style="margin-left:auto;background:#ff6f61;color:#fff;">Cerrar sesión</button>
            </div>
            <div style="margin-bottom:1rem;display:flex;gap:1rem;flex-wrap:wrap;align-items:center;">
                <label for="filter-ip">Filtrar IP:</label>
                <input type="text" id="filter-ip" placeholder="Buscar IP..." style="min-width:120px;">
                <label for="filter-ua">Filtrar dispositivo/navegador:</label>
                <input type="text" id="filter-ua" placeholder="Buscar dispositivo..." style="min-width:180px;">
            </div>
            <table id="visitas-table">
                <thead>
                    <tr><th>#</th><th>IP</th><th>Dispositivo / Navegador</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div class="error" id="admin-error"></div>
    </div>
    <script>
    const API_URL = 'https://ip-counter.stilesrockchock.workers.dev/?totp=';
    const SESSION_KEY = 'admin_totp_session';
    const SESSION_EXPIRY = 12 * 60 * 60 * 1000; // 12 horas en ms

    let autoRefreshTimer = null;
    function isSesionActiva() {
        const totp = obtenerSesion();
        return !!totp;
    }

    let visitasCache = [];
    function renderVisitasTable() {
        const tbody = document.querySelector('#visitas-table tbody');
        const ipFilter = document.getElementById('filter-ip').value.trim().toLowerCase();
        const uaFilter = document.getElementById('filter-ua').value.trim().toLowerCase();
        tbody.innerHTML = '';
        visitasCache
            .filter(v => v && typeof v === 'object' && typeof v.ip === 'string' && (v.ua === undefined || typeof v.ua === 'string'))
            .filter(v => v.ip.toLowerCase().includes(ipFilter) && (v.ua || '').toLowerCase().includes(uaFilter))
            .forEach((v, idx) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${idx+1}</td><td>${v.ip}</td><td>${v.ua || ''}</td>`;
                tbody.appendChild(tr);
            });
    }

    async function cargarVisitas(totp) {
        const error = document.getElementById('admin-error');
        error.textContent = '';
        try {
            const res = await fetch(API_URL + encodeURIComponent(totp), { method: 'GET', mode: 'cors', credentials: 'omit' });
            if (!res.ok) throw new Error('Código incorrecto o error de red');
            const data = await res.json();
            if (!Array.isArray(data.visitas)) throw new Error('Respuesta inesperada');
            document.querySelector('.admin-auth').style.display = 'none';
            document.getElementById('admin-content').style.display = '';
            visitasCache = data.visitas;
            renderVisitasTable();
        } catch(e) {
            error.textContent = e.message;
        }
    }
    document.getElementById('filter-ip').oninput = renderVisitasTable;
    document.getElementById('filter-ua').oninput = renderVisitasTable;

    document.getElementById('admin-export').onclick = function() {
        let csv = 'N°,IP,Dispositivo/Navegador\n';
        visitasCache.forEach((v, idx) => {
            csv += `${idx+1},${v.ip.replace(/,/g,'')},${(v.ua||'').replace(/,/g,'')}\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'visitas.csv';
        document.body.appendChild(a);
        a.click();
        setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(url); }, 1000);
    };
    document.getElementById('admin-paste').onclick = async function() {
        try {
            const text = await navigator.clipboard.readText();
            document.getElementById('admin-totp').value = text.trim();
            document.getElementById('admin-totp').dispatchEvent(new Event('input'));
        } catch(e) {}
    };

    document.getElementById('admin-totp').oninput = function() {
        const val = this.value.trim();
        if (val.length > 6) {
            this.style.borderColor = '#ff6f61';
            document.getElementById('admin-error').textContent = 'El código debe ser de 6 dígitos.';
        } else {
            this.style.borderColor = '';
            document.getElementById('admin-error').textContent = '';
        }
    };

    function guardarSesion(totp) {
        try {
            localStorage.setItem(SESSION_KEY, JSON.stringify({ totp, t: Date.now() }));
        } catch(e) {}
    }
    function obtenerSesion() {
        try {
            const s = JSON.parse(localStorage.getItem(SESSION_KEY));
            if (s && s.t && s.t + SESSION_EXPIRY > Date.now() && s.totp) return s.totp;
        } catch(e) {}
        return null;
    }

    document.getElementById('admin-login').onclick = async function() {
        const totp = document.getElementById('admin-totp').value.trim();
        const error = document.getElementById('admin-error');
        error.textContent = '';
        if (!totp || totp.length !== 6) { error.textContent = 'Ingresa el código TOTP de 6 dígitos.'; return; }
        this.disabled = true;
        await cargarVisitas(totp);
        guardarSesion(totp);
        this.disabled = false;
    };


    document.getElementById('admin-refresh').onclick = function() {
        const totp = obtenerSesion();
        if (totp) cargarVisitas(totp);
    };

    function setAutoRefresh(intervalMs) {
        if (autoRefreshTimer) clearInterval(autoRefreshTimer);
        if (intervalMs > 0) {
            autoRefreshTimer = setInterval(function() {
                if (isSesionActiva()) {
                    const totp = obtenerSesion();
                    cargarVisitas(totp);
                } else {
                    clearInterval(autoRefreshTimer);
                    autoRefreshTimer = null;
                    document.querySelector('.admin-auth').style.display = '';
                    document.getElementById('admin-content').style.display = 'none';
                }
            }, intervalMs);
        }
    }

    document.getElementById('admin-interval').onchange = function() {
        setAutoRefresh(parseInt(this.value, 10));
    };

    // Inicializa con 30s por defecto
    setAutoRefresh(30000);

    document.getElementById('admin-logout').onclick = function() {
        try { localStorage.removeItem(SESSION_KEY); } catch(e) {}
        location.reload();
    };

    // Al cargar la página, intenta sesión
    window.addEventListener('DOMContentLoaded', function() {
        const totp = obtenerSesion();
        if (totp) cargarVisitas(totp);
    });
    </script>
</body>
</html>
